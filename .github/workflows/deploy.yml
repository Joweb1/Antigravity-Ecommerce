name: Build and Deploy to Render Branch

on:
  push:
    branches: [ "main" ]

# Grant permission to push to the repository
permissions:
  contents: write

jobs:
  build-and-package:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # Setup PHP 8.4
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
        extensions: mbstring, xml, bcmath, zip, gd, sqlite3
        tools: composer:v2

    # Setup Node 24
    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: '24'

    - name: Install Composer Dependencies
      run: composer install --no-ansi --no-interaction --no-progress --no-dev --optimize-autoloader

    - name: Install NPM and Build
      run: |
        npm ci
        npm run build
        rm -rf node_modules

    - name: Setup Environment and Database
      run: |
        # Create .env file and generate app key
        cp .env.example .env
        php artisan key:generate
        # Create the database file
        touch database/database.sqlite
        
        # Run migrations
        php artisan migrate --force

    - name: Create Project Archive
      run: |
        # Zip everything, including the now migrated database.sqlite
        zip -r -q release.zip . -x ".git/*" ".github/*"

    - name: Push to Deploy Branch
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        mkdir deploy_artifact
        mv release.zip deploy_artifact/
        cp Dockerfile deploy_artifact/
        
        cd deploy_artifact
        git init
        git checkout -b deploy
        
        git add .
        git commit -m "Deploy: Build $(date +'%Y-%m-%d %H:%M:%S')"
        
        # Push to the deploy branch
        git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        git push origin deploy --force